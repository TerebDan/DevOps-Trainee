pipeline {
    agent any
    environment {
        MAIL = credentials('mail')
        USER = credentials('user_name')
        TG_TOKEN = credentials('tg_notofocations_token')
        TG_ID = credentials('tg_notifications_id')
    }
    stages {    
        stage('Build') {
            steps {
                git branch: 'master', credentialsId: 'ssh_key_jenkins', url: 'git@github.com:TerebDan/DevOps-Trainee.git'
                sh 'cd /var/jenkins_home/workspace/DevOps-Trainee_master'
            }

            post {
                success {
                    sh 'echo "Build: all fine"'
                }
                failure {
                    sh 'echo "Build: fail"'
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    remote_ip = sh (
                        script: 'dig @adelaide.ns.cloudflare.com vm20.admon.com +short',
                        returnStdout: true
                    ).trim()

                    host_ip = sh (
                        script: 'hostname -I',
                        returnStdout: true
                    ).trim()

                    if (remote_ip != host_ip){
                        error "test failed"
                    }
                }
            }

            post {
                success {
                    sh 'echo "Test: all fine"'
                }

                failure {
                    sh 'echo "Test: error"'
                }
            }
        }
    } 
}
